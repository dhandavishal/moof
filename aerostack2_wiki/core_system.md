Relevant source files

-   [as2\_behaviors/as2\_behaviors\_motion/follow\_reference\_behavior/include/follow\_reference\_behavior/follow\_reference\_behavior.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/follow_reference_behavior/include/follow_reference_behavior/follow_reference_behavior.hpp)
-   [as2\_core/include/as2\_core/aerial\_platform.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/aerial_platform.hpp)
-   [as2\_core/include/as2\_core/names/topics.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/names/topics.hpp)
-   [as2\_core/include/as2\_core/sensor.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/sensor.hpp)
-   [as2\_core/include/as2\_core/utils/frame\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/frame_utils.hpp)
-   [as2\_core/include/as2\_core/utils/tf\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/tf_utils.hpp)
-   [as2\_core/src/aerial\_platform.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/aerial_platform.cpp)
-   [as2\_core/src/node.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/node.cpp)
-   [as2\_core/src/platform\_state\_machine.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/platform_state_machine.cpp)
-   [as2\_core/src/rate.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/rate.cpp)
-   [as2\_core/src/sensor.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/sensor.cpp)
-   [as2\_core/src/utils/control\_mode\_utils.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/control_mode_utils.cpp)
-   [as2\_core/src/utils/frame\_utils.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/frame_utils.cpp)
-   [as2\_core/src/utils/tf\_utils.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/tf_utils.cpp)
-   [as2\_core/tests/mocks/aerial\_platform/mock\_aerial\_platform.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/mocks/aerial_platform/mock_aerial_platform.cpp)
-   [as2\_core/tests/mocks/aerial\_platform/mock\_aerial\_platform.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/mocks/aerial_platform/mock_aerial_platform.hpp)
-   [as2\_core/tests/platform\_state\_machine\_test.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/platform_state_machine_test.cpp)
-   [as2\_core/tests/sensor\_test.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/sensor_test.cpp)
-   [as2\_core/tests/tf\_utils\_gtest.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/tf_utils_gtest.cpp)
-   [as2\_motion\_controller/config/motion\_controller\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/config/motion_controller_default.yaml)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_base.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_base.hpp)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_handler.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_handler.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/include/differential\_flatness\_controller/differential\_flatness\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/include/differential_flatness_controller/differential_flatness_controller.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/src/differential\_flatness\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/src/differential_flatness_controller.cpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/include/pid\_speed\_controller/pid\_speed\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/include/pid_speed_controller/pid_speed_controller.hpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/src/pid\_speed\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/src/pid_speed_controller.cpp)
-   [as2\_motion\_controller/src/controller\_handler.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp)
-   [as2\_msgs/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/CMakeLists.txt)
-   [as2\_msgs/msg/PolygonList.msg](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/msg/PolygonList.msg)
-   [as2\_utilities/as2\_geozones/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/CMakeLists.txt)
-   [as2\_utilities/as2\_geozones/config/geozones.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/config/geozones.yaml)
-   [as2\_utilities/as2\_geozones/include/as2\_geozones/as2\_geozones.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/include/as2_geozones/as2_geozones.hpp)
-   [as2\_utilities/as2\_geozones/launch/as2\_geozones\_launch.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/launch/as2_geozones_launch.py)
-   [as2\_utilities/as2\_geozones/src/as2\_geozones.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/src/as2_geozones.cpp)
-   [as2\_utilities/as2\_geozones/src/as2\_geozones\_node.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/src/as2_geozones_node.cpp)
-   [as2\_utilities/as2\_geozones/tests/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_utilities/as2_geozones/tests/CMakeLists.txt)

The Core System is the foundation of the Aerostack2 framework, providing essential building blocks and abstractions for developing autonomous aerial robot applications. It defines standardized interfaces, base classes, and utilities that allow different components of the architecture to work together seamlessly.

For information about specific motion control implementations, see [Motion Control](https://deepwiki.com/aerostack2/aerostack2/2.3-motion-control). For details on state estimation, see [State Estimation](https://deepwiki.com/aerostack2/aerostack2/2.2-state-estimation).

## System Overview

The Core System establishes the framework on which all other Aerostack2 components are built, handling fundamental functionality such as:

-   Aerial platform abstraction and management
-   Message type definitions for component communication
-   Sensor abstractions and integrations
-   Transform and frame utilities
-   Basic node enhancements

```
Core SystemMain Componentsas2_core (Base Classes & Utilities)as2_msgs (Message Definitions)Node (Enhanced ROS2 Node)AerialPlatform (UAV Base)Sensor AbstractionsUtility LibrariesPlatform ImplementationsBehavior SystemHardware InterfacesMotion Controllers
```

Sources: [as2\_core/src/aerial\_platform.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/aerial_platform.cpp) [as2\_core/include/as2\_core/sensor.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/sensor.hpp) [as2\_msgs/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/CMakeLists.txt)

## Key Components

### Aerial Platform

The `as2::AerialPlatform` class is a cornerstone of Aerostack2, serving as a base class for all platform implementations. It provides a unified interface for controlling aerial vehicles, regardless of the specific hardware platform.

```
AerialPlatform+initialize()+resetPlatform()+setArmingState(bool)+setOffboardControl(bool)+setPlatformControlMode(ControlMode)+takeoff()+land()+alertEvent(AlertEvent)+sendCommand()#ownSendCommand()#ownSetArmingState(bool)#ownSetOffboardControl(bool)#ownSetPlatformControlMode(ControlMode)#ownTakeoff()#ownLand()#ownKillSwitch()#ownStopPlatform()PlatformImplementation+ownSendCommand()+ownSetArmingState(bool)+ownSetOffboardControl(bool)+ownSetPlatformControlMode(ControlMode)+ownKillSwitch()+ownStopPlatform()
```

The `AerialPlatform` class manages:

-   Platform state machine (armed, disarmed, taking off, landed, etc.)
-   Control mode management
-   Command handling (pose, twist, trajectory, thrust)
-   Service interfaces for external control
-   Safety mechanisms (emergency stop, kill switch)

Platform-specific implementations must override several virtual methods to provide concrete functionality:

```
// Required implementations for all platforms
virtual bool ownSendCommand() = 0;
virtual bool ownSetArmingState(bool state) = 0;
virtual bool ownSetOffboardControl(bool offboard) = 0;
virtual bool ownSetPlatformControlMode(const as2_msgs::msg::ControlMode & msg) = 0;
virtual void ownKillSwitch() = 0;
virtual void ownStopPlatform() = 0;
```

Sources: [as2\_core/include/as2\_core/aerial\_platform.hpp75-176](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/aerial_platform.hpp#L75-L176) [as2\_core/src/aerial\_platform.cpp44-324](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/aerial_platform.cpp#L44-L324)

### Sensor Framework

The Core System includes a comprehensive sensor framework through the `as2::sensors` namespace, providing abstractions for various sensor types and facilitating integration into Aerostack2.

```
TFStatic+setStaticTransform()TFDynamic+setDynamicTransform()GenericSensor+dataUpdated()#publishData()SensorData<T>+setData()+publish()+updateAndPublish()Sensor<T>+updateData()CameraImuGPSLidarGimbalGroundTruth
```

The sensor framework includes:

-   Base abstractions for all sensors
-   Transform (TF) handling for sensor frames
-   Standard interfaces for publishing sensor data
-   Specialized implementations for common sensors

Common sensor types provided by the framework:

| Sensor Type | Description | Base Classes |
| --- | --- | --- |
| Camera | Camera sensor with image publishing and camera info | TFStatic, GenericSensor |
| Imu | Inertial Measurement Unit | Sensor<sensor\_msgs::msg::Imu> |
| GPS | Global Positioning System | Sensor<sensor\_msgs::msg::NavSatFix> |
| Lidar | Light Detection and Ranging | Sensor<sensor\_msgs::msg::LaserScan> |
| Gimbal | Rotational platform for sensors | TFStatic, TFDynamic, GenericSensor |
| GroundTruth | Simulation ground truth data | GenericSensor |

Sources: [as2\_core/include/as2\_core/sensor.hpp82-785](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/sensor.hpp#L82-L785) [as2\_core/src/sensor.cpp47-516](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/sensor.cpp#L47-L516)

### TF Utilities

The `as2::tf` namespace provides utilities for handling transforms and coordinate conversions. The `TfHandler` class is particularly useful for common transform operations.

```
TfHandler-tf_buffer_-tf_listener_+setTfTimeoutThreshold()+getTfBuffer()+getPoseStamped()+getQuaternionStamped()+getTransform()+convert()+tryConvert()+getState()
```

Key functionalities include:

-   Transform generation and manipulation
-   Frame-to-frame conversions
-   Position and orientation transformations
-   Standard wrappers for common TF2 operations

Example usage:

```
// Create a TF handler
auto tf_handler = std::make_shared<as2::tf::TfHandler>(node_ptr);

// Get a pose in a specific frame
try {
  geometry_msgs::msg::PoseStamped pose = tf_handler->getPoseStamped(
    "odom", "base_link", node_ptr->now());
} catch (tf2::TransformException & ex) {
  RCLCPP_ERROR(node_ptr->get_logger(), "Could not transform pose: %s", ex.what());
}
```

Sources: [as2\_core/include/as2\_core/utils/tf\_utils.hpp67-418](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/tf_utils.hpp#L67-L418) [as2\_core/src/utils/tf\_utils.cpp42-266](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/tf_utils.cpp#L42-L266)

### Frame Utilities

The `as2::frame` namespace provides utilities for frame operations, quaternion manipulations, and basic geometric transformations.

Key functionalities include:

-   Vector transformation using quaternions or Euler angles
-   Quaternion-Euler conversion
-   Angle utilities (wrapping, error calculation)

Example usage:

```
// Transform a vector using a quaternion
Eigen::Vector3d vector(1.0, 0.0, 0.0);
geometry_msgs::msg::Quaternion quaternion;
quaternion.w = 1.0; // No rotation

Eigen::Vector3d transformed_vector = as2::frame::transform(quaternion, vector);

// Convert quaternion to Euler angles
double roll, pitch, yaw;
as2::frame::quaternionToEuler(quaternion, roll, pitch, yaw);
```

Sources: [as2\_core/include/as2\_core/utils/frame\_utils.hpp36-213](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/frame_utils.hpp#L36-L213) [as2\_core/src/utils/frame\_utils.cpp43-213](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/frame_utils.cpp#L43-L213)

### AS2 Messages

The `as2_msgs` package defines the message types used throughout Aerostack2, enabling standardized communication between components.

Key message types include:

-   `ControlMode`: Defines control modes for the platform
-   `PlatformInfo`: Contains information about the platform state
-   `PlatformStatus`: Represents the current status of the platform
-   `TrajectorySetpoints`: Used for trajectory planning
-   `Thrust`: Represents thrust commands

Sources: [as2\_msgs/CMakeLists.txt15-48](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/CMakeLists.txt#L15-L48)

## System Operation

The following diagram shows how the Core System interacts with other components in Aerostack2:

```
State EstimatorPlatform ImplementationAerial PlatformMotion ControllerBehaviorState EstimatorPlatform ImplementationAerial PlatformMotion ControllerBehaviorCore System Components in orangeSet Control ModeownSetPlatformControlMode()Success/FailureSend Trajectory CommandForward CommandGenerate Control OutputownSendCommand()Provide State EstimatePublish Platform Info
```

### Typical Control Flow

1.  A behavior or user interface calls services on the Aerial Platform to:
    
    -   Set the control mode
    -   Arm the platform
    -   Enable offboard control
2.  The Aerial Platform passes these commands to the platform-specific implementation through the virtual methods.
    
3.  Once configured, the behavior sends commands (pose, twist, trajectory) to the Aerial Platform.
    
4.  The Aerial Platform processes these commands and forwards them to the platform-specific implementation.
    
5.  The platform implementation interacts with the hardware to execute the commands.
    
6.  The platform continuously publishes status information that can be monitored by behaviors and user interfaces.
    

Sources: [as2\_core/src/aerial\_platform.cpp197-324](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/aerial_platform.cpp#L197-L324) [as2\_motion\_controller/src/controller\_handler.cpp489-673](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp#L489-L673)

## Integration Examples

### Creating a Sensor

```
// Create an IMU sensor
auto imu = std::make_shared<as2::sensors::Imu>("imu", node_ptr, 100.0); // 100Hz

// Set its transform relative to the base frame
imu->setStaticTransform(
  "imu", "base_link", 
  0.1, 0.0, 0.05,  // x, y, z offset
  0.0, 0.0, 0.0    // roll, pitch, yaw
);

// Update with new data
sensor_msgs::msg::Imu imu_msg;
// Fill imu_msg with data
imu->updateData(imu_msg);
```

### Implementing a Platform

To implement a new platform, extend the `as2::AerialPlatform` class:

```
class MyPlatform : public as2::AerialPlatform {
public:
  MyPlatform() : as2::AerialPlatform() {
    // Initialize platform
    configureSensors();
  }
  
  void configureSensors() override {
    // Set up platform sensors
    imu_ = std::make_shared<as2::sensors::Imu>("imu", this, 100.0);
    gps_ = std::make_shared<as2::sensors::GPS>("gps", this, 10.0);
  }

protected:
  bool ownSendCommand() override {
    // Implement command sending to hardware
    return true;
  }

  bool ownSetArmingState(bool state) override {
    // Implement arming/disarming on hardware
    return true;
  }
  
  // Implement other required methods
  
private:
  std::shared_ptr<as2::sensors::Imu> imu_;
  std::shared_ptr<as2::sensors::GPS> gps_;
};
```

Sources: [as2\_core/include/as2\_core/aerial\_platform.hpp98-176](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/aerial_platform.hpp#L98-L176)

## Configuration

The Core System has several configurable parameters:

| Parameter | Description | Default |
| --- | --- | --- |
| cmd\_freq | Frequency for sending commands | 100.0 Hz |
| info\_freq | Frequency for publishing platform info | 10.0 Hz |
| control\_modes\_file | Path to control modes configuration file | Required |
| tf\_timeout\_threshold | Timeout for TF lookups | 0.05 seconds |

Sources: [as2\_core/src/aerial\_platform.cpp47-65](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/aerial_platform.cpp#L47-L65) [as2\_motion\_controller/config/motion\_controller\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/config/motion_controller_default.yaml)

## Summary

The Core System provides the foundation for Aerostack2, defining standardized interfaces, base classes, and utilities that enable the development of autonomous aerial robot applications. By abstracting common functionality and providing robust infrastructure, it allows developers to focus on application-specific logic rather than boilerplate code and infrastructure concerns.

Sources: [as2\_core/include/as2\_core/aerial\_platform.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/aerial_platform.hpp) [as2\_core/include/as2\_core/sensor.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/sensor.hpp) [as2\_core/include/as2\_core/utils/tf\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/tf_utils.hpp)