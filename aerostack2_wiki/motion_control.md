Relevant source files

-   [as2\_behaviors/as2\_behaviors\_motion/follow\_path\_behavior/plugins/follow\_path\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/follow_path_behavior/plugins/follow_path_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/follow\_reference\_behavior/include/follow\_reference\_behavior/follow\_reference\_behavior.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/follow_reference_behavior/include/follow_reference_behavior/follow_reference_behavior.hpp)
-   [as2\_behaviors/as2\_behaviors\_motion/go\_to\_behavior/plugins/go\_to\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/go_to_behavior/plugins/go_to_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/land\_behavior/plugins/land\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/land_behavior/plugins/land_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/takeoff\_behavior/plugins/takeoff\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/takeoff_behavior/plugins/takeoff_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/CMakeLists.txt)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/CMakeLists.txt)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/config/config\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/config/config_default.yaml)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/include/generate\_polynomial\_trajectory\_behavior/generate\_polynomial\_trajectory\_behavior.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/include/generate_polynomial_trajectory_behavior/generate_polynomial_trajectory_behavior.hpp)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/launch/composable\_generate\_polynomial\_trajectory\_behavior.launch.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/launch/composable_generate_polynomial_trajectory_behavior.launch.py)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/launch/generate\_polynomial\_trajectory\_behavior\_launch.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/launch/generate_polynomial_trajectory_behavior_launch.py)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/src/generate\_polynomial\_trajectory\_behavior.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/src/generate_polynomial_trajectory_behavior.cpp)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/src/generate\_polynomial\_trajectory\_behavior\_node.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/src/generate_polynomial_trajectory_behavior_node.cpp)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/tests/CMakeLists.txt](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/tests/CMakeLists.txt)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/tests/behavior\_test.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/tests/behavior_test.py)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/tests/generate\_polynomial\_trajectory\_behavior\_gtest.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/tests/generate_polynomial_trajectory_behavior_gtest.cpp)
-   [as2\_core/include/as2\_core/utils/tf\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/tf_utils.hpp)
-   [as2\_core/src/utils/tf\_utils.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/tf_utils.cpp)
-   [as2\_core/tests/tf\_utils\_gtest.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/tests/tf_utils_gtest.cpp)
-   [as2\_motion\_controller/config/motion\_controller\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/config/motion_controller_default.yaml)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_base.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_base.hpp)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_handler.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_handler.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/include/differential\_flatness\_controller/differential\_flatness\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/include/differential_flatness_controller/differential_flatness_controller.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/src/differential\_flatness\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/src/differential_flatness_controller.cpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/include/pid\_speed\_controller/pid\_speed\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/include/pid_speed_controller/pid_speed_controller.hpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/src/pid\_speed\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/src/pid_speed_controller.cpp)
-   [as2\_motion\_controller/src/controller\_handler.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp)
-   [as2\_msgs/action/GeneratePolynomialTrajectory.action](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/action/GeneratePolynomialTrajectory.action)
-   [as2\_msgs/msg/YawMode.msg](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/msg/YawMode.msg)
-   [as2\_python\_api/as2\_python\_api/behavior\_actions/trajectory\_generation\_behavior.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_python_api/as2_python_api/behavior_actions/trajectory_generation_behavior.py)
-   [as2\_python\_api/as2\_python\_api/modules/trajectory\_generation\_module.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_python_api/as2_python_api/modules/trajectory_generation_module.py)

This document describes the motion control system within Aerostack2, which is responsible for converting high-level motion references into appropriate commands for the aerial platform. The motion control system sits between behavior actions and the platform abstraction layer, providing the necessary algorithms to achieve precise and stable flight control.

For information about trajectory generation, please see [Trajectory Generation](https://deepwiki.com/aerostack2/aerostack2/3.1-trajectory-generation).

## Overview

The motion control system in Aerostack2 is designed with a plugin-based architecture, allowing different control algorithms to be implemented and selected based on the specific requirements of each application. It handles various control modes, coordinate transformations, and ensures smooth transitions between different motion references.

```
State InformationOutput CommandsInput ReferencesMotion Control SystemControllerHandlerController PluginsControllerBase InterfacePosition ReferencesVelocity ReferencesTrajectory ReferencesThrust ReferencesPose CommandsVelocity CommandsTrajectory CommandsThrust CommandsOdometry DataPlatform Info
```

Sources:

-   [as2\_motion\_controller/src/controller\_handler.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_handler.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_handler.hpp)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_base.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_base.hpp)

## Architecture

The motion control architecture follows a flexible plugin-based system that allows for different control implementations while maintaining a consistent interface.

```
containsControllerBase+initialize(as2::Node*)+updateState(PoseStamped, TwistStamped)+updateReference(PoseStamped)+updateReference(TwistStamped)+updateReference(TrajectorySetpoints)+updateReference(Thrust)+computeOutput(dt, PoseStamped&, TwistStamped&, Thrust&)+setMode(ControlMode, ControlMode)+updateParams(Parameters)+reset()+getDesiredPoseFrameId()+getDesiredTwistFrameId()ControllerHandler-controller_ptr_-node_ptr_-tf_handler_-control_mode_in_-control_mode_out_-state_pose_-state_twist_-ref_pose_-ref_twist_-ref_traj_-ref_thrust_+ControllerHandler(controller, node)+getMode(mode_in, mode_out)+setInputControlModesAvailables(modes)+setOutputControlModesAvailables(modes)+reset()-findSuitableControlModes()-setControlModeSrvCall()-controlTimerCallback()-sendCommand()«interface»PluginImplementationsPIDSpeedControllerDifferentialFlatnessController
```

Sources:

-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_base.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_base.hpp)
-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_handler.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_handler.hpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/include/pid\_speed\_controller/pid\_speed\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/include/pid_speed_controller/pid_speed_controller.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/include/differential\_flatness\_controller/differential\_flatness\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/include/differential_flatness_controller/differential_flatness_controller.hpp)

## Controller Handler

The Controller Handler is the central component that manages the controller plugins and handles the flow of data between the motion references, controller plugins, and platform commands.

### Main Responsibilities

1.  **Subscription Management**: Handles subscriptions to reference topics (pose, twist, trajectory, thrust) and state information (odometry, platform info)
2.  **Control Mode Negotiation**: Finds suitable control modes compatible between reference input, controller capabilities, and platform capabilities
3.  **Frame Transformation**: Manages transformations between different coordinate frames
4.  **Command Publication**: Publishes the control commands to the appropriate topics
5.  **Controller Lifecycle Management**: Initializes, resets, and updates the controller plugin

### Control Mode Handling

The ControllerHandler implements a sophisticated system for negotiating control modes between the input references, available controller plugin modes, and platform capabilities:

```
SuccessFailureYesNoSuccessFailureYesNoSuccessFailureSuccessFailureSuccessFailureSet Control Mode RequestCheck PlatformAvailable ModesIs Hover Mode?Return FailureTry to SetPlatform to HoverUse Bypass?Set Bypass Controllerto TrueTry toBypass ControllerFind SuitableControl ModesSet Input/OutputFrame IDsSet ControllerControl ModeReset ControllerReturn Success
```

Sources:

-   [as2\_motion\_controller/src/controller\_handler.cpp307-435](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp#L307-L435)

### Control Flow

During operation, the controller handler:

1.  Receives state updates from odometry
2.  Receives motion references from various topics
3.  Updates the controller plugin with the latest state and reference
4.  Periodically calls the controller plugin to compute outputs
5.  Sends computed outputs to the platform

This process happens at the configured control frequency (default is 100Hz).

Sources:

-   [as2\_motion\_controller/src/controller\_handler.cpp466-490](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp#L466-L490)
-   [as2\_motion\_controller/config/motion\_controller\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/config/motion_controller_default.yaml)

## Controller Plugins

Aerostack2 comes with multiple controller plugin implementations that can be selected based on the requirements of the application.

### Controller Base Interface

All controller plugins implement the `ControllerBase` interface which defines common methods:

| Method | Purpose |
| --- | --- |
| `initialize()` | Set up the controller with a node pointer |
| `updateState()` | Update the controller with the latest state information |
| `updateReference()` | Update the controller with the latest reference (overloaded for different reference types) |
| `computeOutput()` | Compute the control output based on current state and reference |
| `setMode()` | Configure the controller with input and output control modes |
| `updateParams()` | Update controller parameters |
| `reset()` | Reset the controller's internal state |
| `getDesiredPoseFrameId()` | Get the desired frame ID for pose data |
| `getDesiredTwistFrameId()` | Get the desired frame ID for twist data |

Sources:

-   [as2\_motion\_controller/include/as2\_motion\_controller/controller\_base.hpp54-172](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/include/as2_motion_controller/controller_base.hpp#L54-L172)

### Available Controller Plugins

#### PID Speed Controller

A versatile controller that uses PID control for various control modes:

-   Position control with PID
-   Velocity control with PID
-   Speed-in-a-plane control (useful for certain scenarios)
-   Yaw control with PID
-   Trajectory following with PID

This controller is suitable for most common drone operations and provides stable control with appropriate PID tuning.

```
Control ModesPID Controllers3D Position PID3D Velocity PIDSpeed in Plane PID3D Trajectory PID1D Yaw PIDPosition Control ModeVelocity Control ModeSpeed in Plane ModeTrajectory ModeOutput Commands
```

Sources:

-   [as2\_motion\_controller/plugins/pid\_speed\_controller/include/pid\_speed\_controller/pid\_speed\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/include/pid_speed_controller/pid_speed_controller.hpp)
-   [as2\_motion\_controller/plugins/pid\_speed\_controller/src/pid\_speed\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/pid_speed_controller/src/pid_speed_controller.cpp)

#### Differential Flatness Controller

A more advanced controller that leverages differential flatness properties of multirotor dynamics to achieve precise trajectory tracking. This controller is particularly well-suited for aggressive maneuvers and accurate trajectory following.

Key features:

-   Non-linear dynamics consideration
-   Better trajectory tracking performance
-   Suitable for more demanding applications
-   Supports quaternion-based attitude control

Sources:

-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/include/differential\_flatness\_controller/differential\_flatness\_controller.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/include/differential_flatness_controller/differential_flatness_controller.hpp)
-   [as2\_motion\_controller/plugins/differential\_flatness\_controller/src/differential\_flatness\_controller.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/plugins/differential_flatness_controller/src/differential_flatness_controller.cpp)

## Control Modes

Aerostack2 supports various control modes that define how the drone is controlled. These modes are represented by the `ControlMode` message which contains:

1.  **Control Mode**: Specifies the primary control type (position, velocity, etc.)
2.  **Reference Frame**: Specifies the coordinate frame (local ENU, body FLU, etc.)
3.  **Yaw Mode**: Specifies how yaw is controlled

### Control Mode Types

| Mode | Description |
| --- | --- |
| UNSET | No control mode set |
| HOVER | Hover in place |
| POSITION | Control the position of the drone |
| VELOCITY | Control the velocity of the drone |
| ATTITUDE | Control the attitude of the drone |
| TRAJECTORY | Follow a trajectory with position, velocity, and acceleration setpoints |
| ACRO | Acrobatic mode with direct rate control |

### Reference Frames

| Frame | Description |
| --- | --- |
| LOCAL\_ENU\_FRAME | East-North-Up local frame |
| BODY\_FLU\_FRAME | Forward-Left-Up body frame |
| GLOBAL\_LAT\_LONG\_ASML | Global latitude, longitude, AMSL height |

### Yaw Modes

Yaw control can be specified in several ways:

| Mode | Description |
| --- | --- |
| KEEP\_YAW | Maintain current yaw angle |
| PATH\_FACING | Align yaw with the direction of motion |
| FIXED\_YAW | Fixed yaw angle specified by the user |
| YAW\_FROM\_TOPIC | Get yaw angle from a topic |
| FACE\_REFERENCE | Face the next waypoint in the trajectory |

Sources:

-   [as2\_msgs/msg/YawMode.msg](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_msgs/msg/YawMode.msg)
-   [as2\_core/utils/control\_mode\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/utils/control_mode_utils.hpp)

## Coordinate Frame Transformations

The motion control system heavily relies on coordinate frame transformations to properly handle references and commands in different frames. This is managed by the `TfHandler` class.

### Key Frame Transformations

```
Transform OperationsCommon Framesearthmapodombase_linkconvert(PoseStamped)convert(TwistStamped)convert(Path)getPoseStamped()getState()transform()
```

The controller uses these transformations to:

1.  Convert input references to the required frame for the controller
2.  Convert state information to the required frame for the controller
3.  Convert output commands to the required frame for the platform

Sources:

-   [as2\_core/include/as2\_core/utils/tf\_utils.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/include/as2_core/utils/tf_utils.hpp)
-   [as2\_core/src/utils/tf\_utils.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_core/src/utils/tf_utils.cpp)
-   [as2\_motion\_controller/src/controller\_handler.cpp193-209](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/src/controller_handler.cpp#L193-L209)

## Trajectory Generation Integration

The motion control system integrates with the trajectory generation system to enable smooth and dynamic movements.

### Trajectory Setpoint Format

The motion controller accepts trajectory setpoints that include:

-   Position
-   Velocity
-   Acceleration
-   Yaw angle

### Trajectory Behaviors

Multiple behaviors leverage the motion control and trajectory generation systems:

1.  **Generate Polynomial Trajectory Behavior**: Core behavior that generates smooth polynomial trajectories
2.  **Takeoff using Trajectory**: Uses trajectory generation for smooth takeoff
3.  **Land using Trajectory**: Uses trajectory generation for controlled landing
4.  **GoTo using Trajectory**: Uses trajectory generation to move to a specified position
5.  **Follow Path using Trajectory**: Uses trajectory generation to follow a series of waypoints

```
Motion ControlTrajectory GenerationMotion BehaviorsTrajectorySetpointsPlatform CommandsTakeoffBehaviorLandBehaviorGoToBehaviorFollowPathBehaviorDynamicPolynomialTrajectoryGeneratorMotionControllerAerial Platform
```

Sources:

-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/include/generate\_polynomial\_trajectory\_behavior/generate\_polynomial\_trajectory\_behavior.hpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/include/generate_polynomial_trajectory_behavior/generate_polynomial_trajectory_behavior.hpp)
-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/src/generate\_polynomial\_trajectory\_behavior.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/src/generate_polynomial_trajectory_behavior.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/takeoff\_behavior/plugins/takeoff\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/takeoff_behavior/plugins/takeoff_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/land\_behavior/plugins/land\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/land_behavior/plugins/land_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/go\_to\_behavior/plugins/go\_to\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/go_to_behavior/plugins/go_to_plugin_trajectory.cpp)
-   [as2\_behaviors/as2\_behaviors\_motion/follow\_path\_behavior/plugins/follow\_path\_plugin\_trajectory.cpp](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_motion/follow_path_behavior/plugins/follow_path_plugin_trajectory.cpp)

## Python API Integration

Aerostack2 provides a Python API that allows easy interaction with the motion control system through higher-level abstractions.

### Trajectory Generation Module

The Python API includes a `TrajectoryGenerationModule` that provides methods for generating and following trajectories:

```
# Example usage
drone.trajectory_generation(path, speed, yaw_mode=YawMode.KEEP_YAW)
drone.trajectory_generation.traj_generation_with_path_facing(path, speed)
```

Key methods:

-   `traj_generation_with_keep_yaw()`
-   `traj_generation_with_yaw()`
-   `traj_generation_with_path_facing()`
-   `traj_generation_with_face_reference()`

Sources:

-   [as2\_python\_api/as2\_python\_api/modules/trajectory\_generation\_module.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_python_api/as2_python_api/modules/trajectory_generation_module.py)
-   [as2\_python\_api/as2\_python\_api/behavior\_actions/trajectory\_generation\_behavior.py](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_python_api/as2_python_api/behavior_actions/trajectory_generation_behavior.py)

## Configuration

### Motion Controller Configuration

The motion controller's default configuration:

```
cmd_freq: 100.0              # Hz of controller commands send
info_freq: 10.0              # Hz of controller info publish
odom_frame_id: "odom"        # Frame ID of the odometry
base_frame_id: "base_link"   # Frame ID of the base link
use_bypass: true             # Use bypass mode
tf_timeout_threshold: 0.05   # TF timeout threshold (s)
```

Sources:

-   [as2\_motion\_controller/config/motion\_controller\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_motion_controller/config/motion_controller_default.yaml)

### Trajectory Generator Configuration

The trajectory generator's default configuration:

```
tf_timeout_threshold: 0.05   # TF timeout (50ms)
sampling_n: 1                # Number of sampling of the trajectory
sampling_dt: 0.01            # Time (s) between each sampling
path_lenght: 0               # Length of the waypoints given to the trajectory generator
yaw_threshold: 0.1           # Threshold (m) to compute the yaw angle
yaw_speed_threshold: 6.0     # Threshold (rad/s) to limit the yaw speed
```

Sources:

-   [as2\_behaviors/as2\_behaviors\_trajectory\_generation/generate\_polynomial\_trajectory\_behavior/config/config\_default.yaml](https://github.com/aerostack2/aerostack2/blob/10200cd9/as2_behaviors/as2_behaviors_trajectory_generation/generate_polynomial_trajectory_behavior/config/config_default.yaml)

## Usage Examples

### Setting the Control Mode

To set a control mode via ROS2 service:

```
ros2 service call /namespace/set_control_mode as2_msgs/srv/SetControlMode \
"{control_mode: {control_mode: 4, reference_frame: 1}}"
```

### Sending Position References

To send a position reference via ROS2 topic:

```
ros2 topic pub /namespace/motion_reference/pose geometry_msgs/msg/PoseStamped \
"{header: {frame_id: 'earth'}, pose: {position: {x: 1.0, y: 2.0, z: 3.0}}}"
```

### Using Behaviors

Using the Python API to execute trajectory-based behaviors:

```
# Import the required libraries
from as2_python_api.drone_interface import DroneInterface
from as2_msgs.msg import YawMode
from nav_msgs.msg import Path

# Create a drone instance
drone = DroneInterface('drone0')

# Create a path
path = Path()
# Add waypoints to the path

# Follow the path with path-facing yaw
drone.trajectory_generation.traj_generation_with_path_facing(path, speed=1.0)
```