#!/bin/bash

# Quick Squadron Manager Restart & Test Script
# This script helps you quickly restart squadron manager and test

set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              Squadron Manager - Quick Restart & Test                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

WS_DIR=~/multi_drone_ws

echo "ğŸ”§ What was fixed:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "  âœ… Added debug logging to state/battery/GPS callbacks"
echo "  âœ… Fixed GPS fix_type calculation (was 1, now 2+ for valid fix)"
echo "  âœ… Added diagnostic output when no drones available"
echo "  âœ… Shows battery%, GPS fix, and task status for each drone"
echo ""
echo "ğŸ“‹ INSTRUCTIONS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Step 1: STOP the current Squadron Manager"
echo "   â†’ In the terminal where it's running, press Ctrl+C"
echo ""
echo "Step 2: Source the rebuilt workspace:"
echo "   â†’ source $WS_DIR/install/setup.bash"
echo ""
echo "Step 3: RESTART Squadron Manager with DEBUG logging:"
echo "   â†’ $WS_DIR/scripts/debug_squadron_manager.sh"
echo ""
echo "   OR use standard launch:"
echo "   â†’ ros2 launch squadron_manager squadron_manager.launch.py num_drones:=1"
echo ""
echo "Step 4: Wait 10 seconds for callbacks to receive data"
echo "   â†’ You should see logs like:"
echo "      [DEBUG] State callback for drone_0: connected=True..."
echo "      [DEBUG] Battery callback for drone_0: 100.0%..."
echo "      [DEBUG] GPS callback for drone_0: fix_type=2..."
echo ""
echo "Step 5: Send a test mission:"
echo "   â†’ ./scripts/send_squadron_mission.sh 10 10 15"
echo ""
echo "Step 6: Watch for allocation success:"
echo "   â†’ [INFO] Allocated mission squadron_test_XXX to drone_0"
echo "   â†’ [INFO] Sending mission to drone_0 via TEE"
echo ""
echo "ğŸ¯ EXPECTED RESULTS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "BEFORE (what you saw):"
echo "  âŒ [ERROR] No available drones for mission"
echo "  âŒ Mission bypassed Squadron Manager, sent directly to TEE"
echo ""
echo "AFTER (what you should see now):"
echo "  âœ… [INFO] Drone drone_0 updated: state=UNKNOWN->AVAILABLE"
echo "  âœ… [INFO] Allocated mission squadron_test_XXX to drone_0"
echo "  âœ… [INFO] Sending mission to drone_0 via TEE"
echo "  âœ… Mission executed via Squadron Manager â†’ TEE â†’ FAL â†’ MAVROS"
echo ""
echo "ğŸ” WHAT TO LOOK FOR:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "If you still see 'No available drones', the log will now show WHY:"
echo "  Drone drone_0: state=AVAILABLE, connected=True, battery=100.0%, gps_fix=1, task=None"
echo "                                                                    ^^^^^^^^^"
echo "                                                                    Problem!"
echo ""
echo "This tells you EXACTLY what's wrong (e.g., GPS fix < 2, battery < 20%, etc.)"
echo ""
echo "ğŸ’¡ DEBUGGING TIPS:"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "â€¢ If state stays UNKNOWN:"
echo "    â†’ State callback not firing - check MAVROS connection"
echo ""
echo "â€¢ If battery shows 0.0%:"
echo "    â†’ Battery callback not firing - check /drone_0/mavros/battery topic"
echo ""
echo "â€¢ If gps_fix < 2:"
echo "    â†’ GPS callback not firing OR fix calculation wrong"
echo "    â†’ Check: ros2 topic echo /drone_0/mavros/global_position/global --once"
echo ""
echo "â€¢ If task != None:"
echo "    â†’ Drone thinks it has a task - wait for task to complete or reset"
echo ""
echo "Ready? Follow the steps above! ğŸš€"
echo ""
